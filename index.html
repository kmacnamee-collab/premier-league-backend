<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier League Stats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Lucide icons as SVG components
        const RefreshCw = ({ className, spinning }) => (
            <svg className={className + (spinning ? ' animate-spin' : '')} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>
            </svg>
        );
        
        const Trophy = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
            </svg>
        );
        
        const Calendar = ({ className }) => (
            <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
        );
        
        const TrendingUp = ({ className }) => (
            <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                <polyline points="17 6 23 6 23 12"/>
            </svg>
        );
        
        const History = ({ className }) => (
            <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
                <path d="M12 7v5l4 2"/>
            </svg>
        );
        
        const Server = ({ className }) => (
            <svg className={className} width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/>
                <rect x="2" y="14" width="20" height="8" rx="2" ry="2"/>
                <line x1="6" y1="6" x2="6.01" y2="6"/>
                <line x1="6" y1="18" x2="6.01" y2="18"/>
            </svg>
        );
        
        const ChevronDown = ({ className }) => (
            <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="6 9 12 15 18 9"/>
            </svg>
        );

        const PremierLeagueApp = () => {
            const [activeTab, setActiveTab] = useState('standings');
            const [standings, setStandings] = useState([]);
            const [games, setGames] = useState([]);
            const [upcomingGames, setUpcomingGames] = useState([]);
            const [historicalData, setHistoricalData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdate, setLastUpdate] = useState(null);
            const [backendUrl, setBackendUrl] = useState('https://premier-league-backend.onrender.com');
            const [backendStatus, setBackendStatus] = useState('checking');
            const [showUrlInput, setShowUrlInput] = useState(false);
            const [tempUrl, setTempUrl] = useState('https://premier-league-backend.onrender.com');
            const [expandedTeam, setExpandedTeam] = useState(null);
            const [teamLogos, setTeamLogos] = useState({});

            const checkBackend = async () => {
                try {
                    setBackendStatus('checking');
                    const response = await fetch(`${backendUrl}/api/health`);
                    const data = await response.json();
                    if (data.status === 'OK') {
                        setBackendStatus('connected');
                        return true;
                    }
                    setBackendStatus('disconnected');
                    return false;
                } catch (error) {
                    setBackendStatus('disconnected');
                    return false;
                }
            };

            const fetchTeamLogos = async () => {
                try {
                    // Fetch all Premier League teams to get logos
                    const response = await fetch('https://www.thesportsdb.com/api/v1/json/3/search_all_teams.php?l=English%20Premier%20League');
                    const data = await response.json();
                    if (data.teams) {
                        const logos = {};
                        data.teams.forEach(team => {
                            logos[team.strTeam] = team.strBadge;
                        });
                        setTeamLogos(logos);
                    }
                } catch (err) {
                    console.error('Error fetching logos:', err);
                }
            };

            const fetchStandings = async () => {
                try {
                    const response = await fetch(`${backendUrl}/api/standings`);
                    const data = await response.json();
                    if (data.table) {
                        setStandings(data.table);
                        setError(null);
                        return true;
                    }
                } catch (err) {
                    setError('Cannot connect to backend.');
                    return false;
                }
            };

            const fetchGames = async () => {
                try {
                    const [recent, upcoming] = await Promise.all([
                        fetch(`${backendUrl}/api/games`).then(r => r.json()),
                        fetch(`${backendUrl}/api/games/upcoming`).then(r => r.json())
                    ]);
                    
                    if (recent.events) setGames(recent.events);
                    if (upcoming.events) setUpcomingGames(upcoming.events.slice(0, 10));
                    return true;
                } catch (err) {
                    return false;
                }
            };

            const fetchHistoricalStandings = async () => {
                try {
                    const response = await fetch(`${backendUrl}/api/standings/history`);
                    const data = await response.json();
                    
                    const teamHistory = {};
                    
                    data.forEach(({ season, data: standings }) => {
                        if (standings && standings.length > 0) {
                            standings.forEach(team => {
                                if (!teamHistory[team.strTeam]) {
                                    teamHistory[team.strTeam] = [];
                                }
                                teamHistory[team.strTeam].push({
                                    season,
                                    points: parseInt(team.intPoints) || 0,
                                    position: parseInt(team.intRank) || 0,
                                    played: parseInt(team.intPlayed) || 0
                                });
                            });
                        }
                    });
                    
                    setHistoricalData(teamHistory);
                    return true;
                } catch (err) {
                    return false;
                }
            };

            const loadData = async () => {
                setLoading(true);
                setError(null);
                
                const backendOk = await checkBackend();
                if (!backendOk) {
                    setError('Backend server not responding. It may be waking up (wait 60 seconds).');
                    setLoading(false);
                    return;
                }
                
                await Promise.all([
                    fetchStandings(),
                    fetchGames(),
                    fetchHistoricalStandings(),
                    fetchTeamLogos()
                ]);
                
                setLastUpdate(new Date());
                setLoading(false);
            };

            useEffect(() => {
                loadData();
                const interval = setInterval(loadData, 300000);
                return () => clearInterval(interval);
            }, [backendUrl]);

            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            };

            const formatTime = (timeStr) => {
                if (!timeStr) return '';
                const [hours, minutes] = timeStr.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour % 12 || 12;
                return `${displayHour}:${minutes} ${ampm}`;
            };

            const getTeamRecentGames = (teamName) => {
                if (!games || games.length === 0) return [];
                return games
                    .filter(game => 
                        game.strHomeTeam === teamName || 
                        game.strAwayTeam === teamName
                    )
                    .slice(0, 3);
            };

            const getTopTeamsOverTime = () => {
                const teamTotals = Object.entries(historicalData).map(([team, seasons]) => {
                    const totalPoints = seasons.reduce((sum, s) => sum + s.points, 0);
                    const avgPosition = seasons.reduce((sum, s) => sum + s.position, 0) / seasons.length;
                    return { team, totalPoints, avgPosition, seasons };
                });
                
                return teamTotals.sort((a, b) => b.totalPoints - a.totalPoints).slice(0, 10);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-indigo-900">
                    {/* Header */}
                    <div className="bg-purple-950 text-white p-3 shadow-lg sticky top-0 z-10">
                        <div className="flex justify-between items-center max-w-6xl mx-auto">
                            <div className="flex items-center gap-2">
                                <Trophy className="w-5 h-5" />
                                <h1 className="text-lg font-bold">Premier League 2025-26</h1>
                            </div>
                            <button
                                onClick={loadData}
                                disabled={loading}
                                className="flex items-center gap-2 bg-purple-700 hover:bg-purple-600 px-3 py-1.5 rounded-lg transition-colors disabled:opacity-50"
                            >
                                <RefreshCw className="w-4 h-4" spinning={loading} />
                                <span className="text-sm">Refresh</span>
                            </button>
                        </div>
                        
                        <div className="max-w-6xl mx-auto mt-2 flex items-center justify-center gap-2 text-xs">
                            <Server className="w-3 h-3" />
                            <span className="text-purple-300">Backend:</span>
                            <span className={`px-2 py-0.5 rounded ${
                                backendStatus === 'connected' ? 'bg-green-500/30 text-green-200' :
                                backendStatus === 'disconnected' ? 'bg-red-500/30 text-red-200' :
                                'bg-yellow-500/30 text-yellow-200'
                            }`}>
                                {backendStatus === 'connected' ? 'Connected' : 
                                 backendStatus === 'disconnected' ? 'Disconnected' : 
                                 'Checking...'}
                            </span>
                            <button
                                onClick={() => setShowUrlInput(!showUrlInput)}
                                className="ml-2 text-purple-300 hover:text-white text-xs underline"
                            >
                                Change URL
                            </button>
                        </div>
                        
                        {showUrlInput && (
                            <div className="max-w-6xl mx-auto mt-2 flex items-center justify-center gap-2">
                                <input
                                    type="text"
                                    value={tempUrl}
                                    onChange={(e) => setTempUrl(e.target.value)}
                                    placeholder="https://your-app.onrender.com"
                                    className="bg-purple-900 text-white px-3 py-1 rounded text-xs border border-purple-700 flex-1 max-w-xs"
                                />
                                <button
                                    onClick={() => {
                                        setBackendUrl(tempUrl);
                                        setShowUrlInput(false);
                                        setTimeout(loadData, 100);
                                    }}
                                    className="bg-purple-700 hover:bg-purple-600 px-3 py-1 rounded text-xs"
                                >
                                    Update
                                </button>
                            </div>
                        )}
                        
                        {lastUpdate && (
                            <div className="text-xs text-purple-300 text-center mt-1">
                                Updated: {lastUpdate.toLocaleTimeString()}
                            </div>
                        )}
                    </div>

                    {/* Tabs */}
                    <div className="bg-purple-900 border-b border-purple-700">
                        <div className="max-w-6xl mx-auto flex">
                            <button
                                onClick={() => setActiveTab('standings')}
                                className={`flex-1 py-2 px-4 text-sm font-medium transition-colors ${
                                    activeTab === 'standings'
                                        ? 'bg-purple-800 text-white border-b-2 border-white'
                                        : 'text-purple-200 hover:bg-purple-800'
                                }`}
                            >
                                <div className="flex items-center justify-center gap-2">
                                    <TrendingUp className="w-4 h-4" />
                                    Standings
                                </div>
                            </button>
                            <button
                                onClick={() => setActiveTab('games')}
                                className={`flex-1 py-2 px-4 text-sm font-medium transition-colors ${
                                    activeTab === 'games'
                                        ? 'bg-purple-800 text-white border-b-2 border-white'
                                        : 'text-purple-200 hover:bg-purple-800'
                                }`}
                            >
                                <div className="flex items-center justify-center gap-2">
                                    <Calendar className="w-4 h-4" />
                                    Fixtures
                                </div>
                            </button>
                            <button
                                onClick={() => setActiveTab('history')}
                                className={`flex-1 py-2 px-4 text-sm font-medium transition-colors ${
                                    activeTab === 'history'
                                        ? 'bg-purple-800 text-white border-b-2 border-white'
                                        : 'text-purple-200 hover:bg-purple-800'
                                }`}
                            >
                                <div className="flex items-center justify-center gap-2">
                                    <History className="w-4 h-4" />
                                    History
                                </div>
                            </button>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="max-w-6xl mx-auto p-3">
                        {error && (
                            <div className="bg-red-500/20 border border-red-500/50 rounded-lg p-3 mb-3 text-white text-sm">
                                {error}
                            </div>
                        )}

                        {loading && !standings.length ? (
                            <div className="text-white text-center py-12">
                                <RefreshCw className="w-8 h-8 mx-auto mb-2" spinning={true} />
                                <div>Loading Premier League data...</div>
                                <div className="text-xs text-purple-300 mt-2">First load may take 60 seconds</div>
                            </div>
                        ) : (
                            <>
                                {activeTab === 'standings' && standings.length > 0 && (
                                    <div className="bg-white/10 backdrop-blur-sm rounded-lg overflow-hidden">
                                        {/* Table Header */}
                                        <div className="bg-purple-900/50 text-white text-xs font-semibold border-b border-purple-700">
                                            <div className="grid grid-cols-12 gap-2 px-3 py-2">
                                                <div className="col-span-1 text-center">#</div>
                                                <div className="col-span-5">Team</div>
                                                <div className="col-span-1 text-center">P</div>
                                                <div className="col-span-1 text-center">W</div>
                                                <div className="col-span-1 text-center">D</div>
                                                <div className="col-span-1 text-center">L</div>
                                                <div className="col-span-1 text-center">GD</div>
                                                <div className="col-span-1 text-center font-bold">Pts</div>
                                            </div>
                                        </div>
                                        
                                        {/* Table Body */}
                                        <div>
                                            {standings.map((team, idx) => {
                                                const 
